<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mobile FPS Game</title>
<style>
body { margin:0; overflow:hidden; touch-action:none; font-family:sans-serif; }
canvas { display:block; }
#menu { position:absolute; top:0; left:0; width:100%; height:100%; background:#111; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; }
.menu-button { margin:10px; padding:15px 30px; background:#333; border:none; border-radius:10px; font-size:18px; color:white; }
#hud { position:absolute; top: 10px; left: 10px; color: white; }
#ammo { position:absolute; bottom:50px; left:20px; color:white; }
#healthBarContainer { position:absolute; bottom:20px; left:20px; width:200px; height:25px; background:#555; border:2px solid white; }
#healthBar { width:100%; height:100%; background:limegreen; }
.button { position:absolute; width:60px; height:60px; background:rgba(255,255,255,0.3); border-radius:50%; }
#up { bottom:100px; left:80px; } #down { bottom:20px; left:80px; }
#left { bottom:60px; left:20px; } #right { bottom:60px; left:140px; }
#reload { bottom:140px; right:20px; width:50px; height:50px; background:rgba(255,255,0,0.4); border-radius:50%; }
</style>
</head>
<body>

<!-- Menu -->
<div id="menu">
  <h1>Mobile FPS</h1>
  <div id="difficulty-selection">
    <h2>Choose Difficulty</h2>
    <button class="menu-button" onclick="chooseDifficulty('easy')">Easy</button>
    <button class="menu-button" onclick="chooseDifficulty('medium')">Medium</button>
    <button class="menu-button" onclick="chooseDifficulty('hard')">Hard</button>
  </div>
  <div id="map-selection" style="display:none;">
    <h2>Choose Map</h2>
    <div id="maps">
      <button class="menu-button" onclick="startGame(1)">Map 1</button>
      <button class="menu-button" onclick="startGame(2)">Map 2</button>
      <button class="menu-button" onclick="startGame(3)">Map 3</button>
      <button class="menu-button" onclick="startGame(4)">Map 4</button>
      <button class="menu-button" onclick="startGame(5)">Map 5</button>
      <button class="menu-button" onclick="startGame(6)">Map 6</button>
      <button class="menu-button" onclick="startGame(7)">Map 7</button>
      <button class="menu-button" onclick="startGame(8)">Map 8</button>
      <button class="menu-button" onclick="startGame(9)">Map 9</button>
      <button class="menu-button" onclick="startGame(10)">Map 10</button>
    </div>
  </div>
</div>

<!-- HUD -->
<div id="hud">Gun: AR</div>
<div id="ammo"></div>
<div id="healthBarContainer"><div id="healthBar"></div></div>

<!-- Touch Buttons -->
<div id="up" class="button"></div>
<div id="down" class="button"></div>
<div id="left" class="button"></div>
<div id="right" class="button"></div>
<div id="reload" class="button"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/PointerLockControls.js"></script>

<script>
let scene, camera, renderer, controls;
let bullets=[], enemyBullets=[], bots=[];
let gunIndex=0, playerHealth=100, lastShot=0, reloading=false;
let move={up:false,down:false,left:false,right:false};
let touchLook={active:false,lastX:0,lastY:0};
let botDifficulty='easy', selectedMap=1;

const hud=document.getElementById('hud');
const ammoDiv=document.getElementById('ammo');
const healthBar=document.getElementById('healthBar');

const guns=[
  {name:'AR', damage:20, speed:2, cooldown:200, ammo:30, maxAmmo:30, reloadTime:1500},
  {name:'SMG', damage:10, speed:3, cooldown:100, ammo:50, maxAmmo:50, reloadTime:1200},
  {name:'Shotgun', damage:40, speed:1, cooldown:800, ammo:8, maxAmmo:8, reloadTime:2000, spread:5},
  {name:'Sniper', damage:80, speed:5, cooldown:1500, ammo:5, maxAmmo:5, reloadTime:2500}
];

const difficultySettings = {
  easy: {speed:0.02, cooldown:1200, damage:5},
  medium: {speed:0.04, cooldown:1000, damage:10},
  hard: {speed:0.06, cooldown:700, damage:15}
};

// ----- Menu -----
function chooseDifficulty(diff){
  botDifficulty=diff;
  document.getElementById('difficulty-selection').style.display='none';
  document.getElementById('map-selection').style.display='block';
}

function startGame(mapNum){
  selectedMap=mapNum;
  document.getElementById('menu').style.display='none';
  init();
  animate();
}

// ----- Initialize Scene -----
function init(){
  scene=new THREE.Scene();
  const mapColors=[0x222222,0x003300,0x330000,0x000033,0x333300,0x003333,0x333033,0x663300,0x336600,0x663366];
  scene.background=new THREE.Color(mapColors[selectedMap-1]||0x222222);

  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
  camera.position.set(0,2,5);
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const light=new THREE.DirectionalLight(0xffffff,1);
  light.position.set(5,10,7); scene.add(light);

  const groundGeo=new THREE.PlaneGeometry(100,100);
  const groundMat=new THREE.MeshStandardMaterial({color:0x555555});
  const ground=new THREE.Mesh(groundGeo,groundMat); ground.rotation.x=-Math.PI/2; scene.add(ground);

  createMapLayout(selectedMap);
  spawnBots();

  controls=new THREE.PointerLockControls(camera,document.body);
  document.body.addEventListener('click',()=>controls.lock());

  // Touch Look
  renderer.domElement.addEventListener('touchstart', e=>{
    if(!["reload","up","down","left","right"].includes(e.target.id)){
      touchLook.active=true; touchLook.lastX=e.touches[0].clientX; touchLook.lastY=e.touches[0].clientY;
    }
  });
  renderer.domElement.addEventListener('touchmove', e=>{
    if(touchLook.active){
      const deltaX=(e.touches[0].clientX-touchLook.lastX)*0.002;
      const deltaY=(e.touches[0].clientY-touchLook.lastY)*0.002;
      controls.getObject().rotation.y-=deltaX;
      camera.rotation.x-=deltaY;
      camera.rotation.x=Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
      touchLook.lastX=e.touches[0].clientX; touchLook.lastY=e.touches[0].clientY;
    }
  });
  renderer.domElement.addEventListener('touchend', e=>{touchLook.active=false;});

  // Mobile buttons
  ["up","down","left","right"].forEach(dir=>{
    document.getElementById(dir).addEventListener('touchstart',()=>move[dir]=true);
    document.getElementById(dir).addEventListener('touchend',()=>move[dir]=false);
  });
  document.getElementById('reload').addEventListener('touchstart', reloadGun);

  window.addEventListener('resize', ()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });
}

// ----- Map Layouts -----
function createMapLayout(mapNum){
  const existing = scene.getObjectByName('obstacles');
  if(existing) scene.remove(existing);
  const group=new THREE.Group(); group.name='obstacles';

  switch(mapNum){
    case 1: addHouse(group,-6,-6); addHouse(group,6,6); addWall(group,-10,0.5,-10,2,2,2); addWall(group,10,0.5,10,2,2,2); addWall(group,-10,0.5,10,2,2,2); addWall(group,10,0.5,-10,2,2,2); break;
    case 2: addHouse(group,0,0); for(let i=0;i<4;i++){ addWall(group,Math.random()*16-8,0.5,Math.random()*16-8,2,2,2); } break;
    case 3: for(let i=0;i<5;i++){ addHouse(group,Math.random()*18-9,Math.random()*18-9,3,3,2.5); } break;
    case 4: addWall(group,-5,0.5,0,2,2,8); addWall(group,5,0.5,0,2,2,8); addHouse(group,0,0); break;
    case 5: addHouse(group,-6,0,5,5,4); addHouse(group,6,0,5,5,4); addWall(group,0,0.5,5,2,2,2); addWall(group,0,0.5,-5,2,2,2); break;
    case 6: for(let i=0;i<3;i++){ addHouse(group,Math.random()*12-6,Math.random()*12-6,3,3,3); } for(let i=0;i<5;i++){ addWall(group,Math.random()*14-7,0.5,Math.random()*14-7,2,2,2); } break;
    case 7: addWall(group,0,0.5,0,1,2,12); addWall(group,0,0.5,0,12,2,1); addHouse(group,0,0,3,3,3); break;
    case 8: addHouse(group,-5,-5,4,4,3); addHouse(group,5,5,4,4,3); for(let i=0;i<6;i++){ addWall(group,Math.random()*18-9,0.5,Math.random()*18-9,2,2,2); } break;
    case 9: for(let i=-8;i<=8;i+=4){ addWall(group,i,0.5,8,1,2,1); addWall(group,i,0.5,-8,1,2,1); } for(let i=-8;i<=8;i+=4){ addWall(group,8,0.5,i,1,2,1); addWall(group,-8,0.5,i,1,2,1); } addHouse(group,0,0,5,5,4); break;
    case 10: for(let i=-6;i<=6;i+=3){ for(let j=-6;j<=6;j+=3){ addWall(group,i,0.5,j,1,2,1); } } addHouse(group,-4,4,3,3,3); addHouse(group,4,-4,3,3,3); break;
  }

  scene.add(group);
}

function addHouse(parent,x,z,width=4,depth=4,height=3){
  const wallGeo=new THREE.BoxGeometry(width,height,depth);
  const wallMat=new THREE.MeshStandardMaterial({color:0x8B4513});
  const walls=new THREE.Mesh(wallGeo,wallMat); walls.position.set(x,height/2,z); parent.add(walls);
  const roofGeo=new THREE.ConeGeometry(Math.max(width,depth)/1.5,2,4);
  const roofMat=new THREE.MeshStandardMaterial({color:0xAA0000});
  const roof=new THREE.Mesh(roofGeo,roofMat); roof.position.set(x,height+1,z); roof.rotation.y=Math.PI/4; parent.add(roof);
}

function addWall(parent,x,y,z,width,height,depth){
  const geo=new THREE.BoxGeometry(width,height,depth);
  const mat=new THREE.MeshStandardMaterial({color:0x666666});
  const wall=new THREE.Mesh(geo,mat); wall.position.set(x,y,z); parent.add(wall);
}

// ----- Bots -----
function spawnBots(){
  bots=[];
  for(let i=0;i<5;i++){
    const geo=new THREE.BoxGeometry(1,1,1);
    const mat=new THREE.MeshStandardMaterial({color:0xff0000});
    const bot=new THREE.Mesh(geo,mat);
    bot.position.set(Math.random()*20-10,0.5,Math.random()*20-10);
    bot.health=100;
    bot.speed=difficultySettings[botDifficulty].speed;
    bot.lastShot=0;
    scene.add(bot); bots.push(bot);
  }
}

// ----- Shooting -----
function shoot(){
  if(reloading) return;
  const gun=guns[gunIndex];
  if(gun.ammo<=0){ reloadGun(); return; }
  const now=Date.now(); if(now-lastShot<gun.cooldown) return;
  lastShot=now; gun.ammo--;
  if(gun.name==='Shotgun'){ for(let i=-gun.spread;i<=gun.spread;i++){ spawnBullet(i*0.05,gun); } }
  else spawnBullet(0,gun);
}

function spawnBullet(angleOffset,gun){
  const geo=new THREE.SphereGeometry(0.1,8,8);
  const mat=new THREE.MeshBasicMaterial({color:0xffff00});
  const bullet=new THREE.Mesh(geo,mat);
  bullet.position.copy(camera.position);
  bullet.direction=new THREE.Vector3(); camera.getWorldDirection(bullet.direction);
  bullet.direction.applyAxisAngle(new THREE.Vector3(0,1,0),angleOffset);
  bullet.speed=gun.speed; bullet.damage=gun.damage;
  bullets.push(bullet); scene.add(bullet);
}

function reloadGun(){ if(reloading) return; reloading=true;
  const gun=guns[gunIndex]; setTimeout(()=>{gun.ammo=gun.maxAmmo; reloading=false;}, gun.reloadTime); }

// ----- Bot Movement with Collision -----
function moveBot(bot){
  if(bot.health <= 0) return;
  let toPlayer = new THREE.Vector3().subVectors(camera.position, bot.position).normalize();
  let nextPos = bot.position.clone().add(toPlayer.clone().multiplyScalar(bot.speed));

  const obstacles = scene.getObjectByName('obstacles')?.children || [];
  let collided = false;
  for(const obs of obstacles){
    const distance = nextPos.distanceTo(obs.position);
    const minDist = 1 + Math.max(obs.scale.x || 1, obs.scale.z || 1)/2;
    if(distance < minDist){ collided = true; break; }
  }

  if(!collided){ bot.position.copy(nextPos); }
  else{ const slide = new THREE.Vector3(-toPlayer.z, 0, toPlayer.x).multiplyScalar(bot.speed); bot.position.add(slide); }

  if(Date.now() - bot.lastShot > difficultySettings[botDifficulty].cooldown){
    bot.lastShot = Date.now();
    shootEnemy(bot, toPlayer);
  }
}

function shootEnemy(bot,dir){
  const geo=new THREE.SphereGeometry(0.1,8,8);
  const mat=new THREE.MeshBasicMaterial({color:0xff00ff});
  const bullet=new THREE.Mesh(geo,mat);
  bullet.position.copy(bot.position);
  bullet.direction=dir.clone();
  bullet.speed=0.5+Math.random()*0.3; bullet.damage=difficultySettings[botDifficulty].damage;
  enemyBullets.push(bullet); scene.add(bullet);
}

// ----- Animate -----
function animate(){
  requestAnimationFrame(animate);
  hud.innerText = `Gun: ${guns[gunIndex].name}`;
  ammoDiv.innerText = reloading ? 'Reloading...' : `Ammo: ${guns[gunIndex].ammo}/${guns[gunIndex].maxAmmo}`;
  healthBar.style.width = `${playerHealth}%`;

  // Auto-shoot at bots
  const dir = new THREE.Vector3(); camera.getWorldDirection(dir);
  const aliveBots = bots.filter(b => b.health > 0);
  for(const b of aliveBots){
    const toBot = new THREE.Vector3().subVectors(b.position, camera.position).normalize();
    if(toBot.dot(dir) > 0.99){ shoot(); break; }
  }

  // Player bullets
  bullets.forEach((b,i)=>{
    b.position.add(b.direction.clone().multiplyScalar(b.speed));
    bots.forEach(bot=>{if(bot.position.distanceTo(b.position)<1){ bot.health-=b.damage; scene.remove(b); bullets.splice(i,1); }});
    if(b.position.length>100){ scene.remove(b); bullets.splice(i,1); }
  });

  // Move bots with collision
  aliveBots.forEach(bot => moveBot(bot));

  // Enemy bullets
  enemyBullets.forEach((b,i)=>{
    b.position.add(b.direction.clone().multiplyScalar(b.speed));
    if(b.position.distanceTo(camera.position)<1){ playerHealth -= b.damage; scene.remove(b); enemyBullets.splice(i,1); }
    if(b.position.length>100){ scene.remove(b); enemyBullets.splice(i,1); }
  });

  // Player movement
  const speed = 0.1;
  if(move.up) controls.moveForward(speed);
  if(move.down) controls.moveForward(-speed);
  if(move.left) controls.moveRight(-speed);
  if(move.right) controls.moveRight(speed);

  // Respawn
  if(playerHealth <= 0) respawn();

  renderer.render(scene, camera);
}

// ----- Respawn -----
function respawn(){
  playerHealth = 100;
  camera.position.set(Math.random()*10-5, 2, Math.random()*10-5);
  guns.forEach(g => g.ammo = g.maxAmmo);
}

// ----- Gun Switch & Shoot -----
window.addEventListener('keydown', e => {
  if(e.key >= '1' && e.key <= '4') gunIndex = parseInt(e.key)-1;
  if(e.key === 'r') reloadGun();
});
window.addEventListener('click', shoot);
</script>
</body>
</html>
